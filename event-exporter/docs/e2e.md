# Event Exporter E2E Workflow

This document describes the local end-to-end (E2E) workflow used to validate
functional parity and compare performance between `core/v1` Events and
`events.k8s.io/v1` series updates.

## What the E2E test covers
- Validates that events flow end-to-end from the API server to the exporter
  (using a local in-memory sink).
- Verifies required fields are present (`InvolvedObject`, `Reason`, `Message`).
- Reports throughput (occurrences per second) for both core/v1 and events/v1.

## Prerequisites
- Go toolchain (matches `event-exporter/go.mod`)
- kind (Kubernetes in Docker)
  - Install: `go install sigs.k8s.io/kind@v0.24.0`
- kubectl (optional, for inspection/debugging)

## Quick start
From the repository root:

```sh
event-exporter/hack/e2e-kind.sh
```

The script:
- Creates or reuses a kind cluster (`event-exporter-e2e` by default).
- Runs `go test -tags e2e` with a kubeconfig generated by kind.
- Prints per-path throughput logs in the test output.

## Configuration knobs
All values are optional and can be exported before running the script.

- `KIND_CLUSTER_NAME` (default `event-exporter-e2e`)
- `E2E_EVENT_COUNT` (default `200`)
- `E2E_SERIES_STEP` (default `10`)
- `E2E_TIMEOUT` (default `2m`)
- `E2E_NAMESPACE` (default `event-exporter-e2e`)
- `E2E_KEEP_CLUSTER` (default `true`)

Example:

```sh
E2E_EVENT_COUNT=1000 E2E_SERIES_STEP=20 E2E_TIMEOUT=5m event-exporter/hack/e2e-kind.sh
```

## Interpreting results
The test logs two lines:
- `core/v1: processed=... occurrences=... throughput=...`
- `events.k8s.io/v1: processed=... occurrences=... throughput=...`

Higher throughput in the events/v1 path is expected because series updates
reduce watch update volume for repeated events.

## Results template
Use this block in PRs to keep reporting consistent:

```text
E2E env:
  KIND_CLUSTER_NAME=event-exporter-e2e
  E2E_EVENT_COUNT=200
  E2E_SERIES_STEP=10
  E2E_TIMEOUT=2m
  E2E_NAMESPACE=event-exporter-e2e

Results:
  core/v1: processed=..., updates=..., occurrences=..., elapsed=..., throughput=... occ/s
  events.k8s.io/v1: processed=..., updates=..., occurrences=..., elapsed=..., throughput=... occ/s
```

## Cleanup
If you do not want to keep the cluster:

```sh
E2E_KEEP_CLUSTER=false event-exporter/hack/e2e-kind.sh
```

Or delete manually:

```sh
kind delete cluster --name event-exporter-e2e
```
